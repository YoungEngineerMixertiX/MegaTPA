/*
  üöÄ MegaTPA Full Demo ‚Äî by 12yo Embedded Master
  –í–∫–ª—é—á–∞–µ—Ç:
    - trm: —Ç–∞–π–º–µ—Ä—ã (–ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –∏ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ)
    - bnm: –∫–Ω–æ–ø–∫–∞ —Å –∞–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥–æ–º
    - stm: —Å–æ—Ñ—Ç-PWM –¥–ª—è LED
    - bldc: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ BLDC-–º–æ—Ç–æ—Ä–æ–º
    - shs: —Å–æ—Ñ—Ç-—Å–µ—Ä–∏–∞–ª –¥–ª—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É Arduino

  –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:
    - –ö–Ω–æ–ø–∫–∞: –ø–∏–Ω 2 ‚Üí GND (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ–¥—Ç—è–∂–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞)
    - LED: –ø–∏–Ω 9 (—á–µ—Ä–µ–∑ —Ä–µ–∑–∏—Å—Ç–æ—Ä 220 –û–º)
    - BLDC: –ø–∏–Ω—ã 3, 4, 5 ‚Üí –¥—Ä–∞–π–≤–µ—Ä –º–æ—Ç–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, IR2104 + MOSFETs)
    - shs (—Å–æ—Ñ—Ç-—Å–µ—Ä–∏–∞–ª):
        TX ‚Üí –ø–∏–Ω 6
        RX ‚Üê –ø–∏–Ω 7   (–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ TX –¥—Ä—É–≥–æ–π Arduino)

  –î–ª—è —Ç–µ—Å—Ç–∞ shs:
    - –ó–∞–≥—Ä—É–∑–∏ —ç—Ç–æ—Ç —Å–∫–µ—Ç—á –Ω–∞ Arduino #1
    - –ù–∞ Arduino #2 –∑–∞–≥—Ä—É–∑–∏ –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏—ë–º–Ω–∏–∫ (—Å–º. –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∏–∂–µ)
*/

#include <MegaTPA.h>

// –¢–∞–π–º–µ—Ä—ã
trm timer1(1000);        // –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
trm timer2(250);         // –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ —á–µ—Ä–µ–∑ 250 –º—Å
trm motorRunTimer(3000); // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ—Ç–æ—Ä–∞ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫

// –ö–Ω–æ–ø–∫–∞ –Ω–∞ –ø–∏–Ω–µ 2 (—Å –ø–æ–¥—Ç—è–∂–∫–æ–π)
bnm button(2, "pullup");

// PWM –¥–ª—è LED –Ω–∞ –ø–∏–Ω–µ 9
stm led(9);

// BLDC –º–æ—Ç–æ—Ä –Ω–∞ –ø–∏–Ω–∞—Ö 3, 4, 5 (–±–µ–∑ –¥–∞—Ç—á–∏–∫–∞ –æ–±–æ—Ä–æ—Ç–æ–≤)
bldc motor(3, 4, 5);

// –°–æ—Ñ—Ç-—Å–µ—Ä–∏–∞–ª: RX=7, TX=6
shs link(7, 6);

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ—Ç–æ—Ä–∞
bool motorRunning = false;

void setup() {
  Serial.begin(115200);
  Serial.println("üöÄ MegaTPA Full Demo ‚Äî Timer + BLDC + shs");
  Serial.println("üì° shs (—Å–æ—Ñ—Ç-—Å–µ—Ä–∏–∞–ª) —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–∏–Ω–∞—Ö: RX=7, TX=6");
  Serial.println("üí¨ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ shs...");

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è shs
  link.begin(4800);
  link.sendString("Hello from MegaTPA!");
  link.send(0x42); // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–∞–π—Ç –∫–∞–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
}

void loop() {
  // === –¢–∞–π–º–µ—Ä—ã ===
  if (timer1.end()) {
    Serial.println("‚è∞ [timer1.end()] ‚Äî –ü—Ä–æ—à–ª–∞ 1 —Å–µ–∫—É–Ω–¥–∞!");
    link.sendString("Ping from timer1");
  }

  if (timer2.oneEnd()) {
    Serial.println("üéØ [timer2.oneEnd()] ‚Äî 250 –º—Å –ø—Ä–æ—à–ª–∏ ‚Äî –±–æ–ª—å—à–µ –Ω–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è!");
  }

  // === –ö–Ω–æ–ø–∫–∞ ===
  if (button.pressed()) {
    Serial.println("üñ±Ô∏è  –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞!");
    motor.writespeed(100); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
    link.sendString("Button pressed!");
  }

  // === LED –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –∫–Ω–æ–ø–∫–∏ ===
  led.set(button.held() ? 200 : 50); // held() = —É–¥–µ—Ä–∂–∞–Ω–∏–µ
  led.update(); // –í–ê–ñ–ù–û: –≤—ã–∑—ã–≤–∞—Ç—å update() –¥–ª—è stm!

  // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ—Ç–æ—Ä–æ–º ===
  if (motorRunTimer.end()) {
    motorRunning = !motorRunning;

    if (motorRunning) {
      Serial.println("‚ö° –í–∫–ª—é—á–∞–µ–º –º–æ—Ç–æ—Ä (—Ä–µ–∂–∏–º loop)");
      motor.writespeed(30);
      motor.loop(); // –º–æ—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ
    } else {
      Serial.println("üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ—Ç–æ—Ä");
      motor.writespeed(0);
      // loop() —É–∂–µ –≤—ã–∫–ª—é—á–µ–Ω, –¥–æ–ø. –≤—ã–∑–æ–≤ –Ω–µ –Ω—É–∂–µ–Ω
    }
  }

  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –º–æ—Ç–æ—Ä –≤ loop!
  motor.update();

  // === –ü—Ä–∏—ë–º –¥–∞–Ω–Ω—ã—Ö –ø–æ shs ===
  int b = link.read();
  if (b != -1) {
    Serial.print("üì• –ü–æ–ª—É—á–µ–Ω –±–∞–π—Ç –ø–æ shs: 0x");
    Serial.println(b, HEX);
    // –ú–æ–∂–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å: –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–∫–ª—é—á–∏—Ç—å LED
    if (b == 0xFF) led.set(255);
  }

  // === –ü—Ä–∏—ë–º —Å—Ç—Ä–æ–∫–∏ –ø–æ shs ===
  char* msg = link.readString();
  if (strlen(msg) > 0) {
    Serial.print("üì® –ü–æ–ª—É—á–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞: ");
    Serial.println(msg);
    link.sendString("ACK: got your message!");
  }

  delay(10); // –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ Serial
}
