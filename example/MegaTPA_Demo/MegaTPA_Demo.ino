#include <MegaTPA.h>

trm  timer1(1000);   // 1 —Å–µ–∫
trm  timer2(250);    // 250 –º—Å
trm motorRunTimer(2500); // 2.5 —Å–µ–∫
bnm  button(2, "pullup");
stm  led(9);
bldc motor(3, 4, 5); // –ü–∏–Ω—ã –¥–ª—è –º–æ—Ç–æ—Ä–∞

void setup() {
  Serial.begin(115200);
  Serial.println("üöÄ MegaTPA Timer Demo + BLDC Motor ‚Äî if-style by 12yo Master");
}

void loop() {
  // –ü–æ–≤—Ç–æ—Ä—è—é—â–µ–µ—Å—è —Å–æ–±—ã—Ç–∏–µ ‚Äî –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
  if (timer1.end()) {
    Serial.println("‚è∞ [timer1.end()] ‚Äî –ü—Ä–æ—à–ª–∞ 1 —Å–µ–∫—É–Ω–¥–∞!");
  }

  // –û–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  if (timer2.oneEnd()) {
    Serial.println("üéØ [timer2.oneEnd()] ‚Äî –ü—Ä–æ—à–ª–æ 250 –º—Å ‚Äî –∏ –±–æ–ª—å—à–µ –Ω–∏–∫–æ–≥–¥–∞!");
  }

  // –ö–Ω–æ–ø–∫–∞
  if (button.pressed()) {
    Serial.println("üñ±Ô∏è  –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞!");
    motor.setSpeed(100); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
  }

  // LED ‚Äî —è—Ä–∫–æ—Å—Ç—å –ø–æ –∫–Ω–æ–ø–∫–µ
  led.set(button.pressed() ? 200 : 50);
  
  // –ö–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ—Ç–æ—Ä–∞
  if (motorRunTimer.end()) {
    motorRunning = !motorRunning;
    
    if (motorRunning) {
      Serial.println("‚ö° –í–∫–ª—é—á–∞–µ–º –º–æ—Ç–æ—Ä –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ 20");
      motor.setSpeed(20);
      motor.loop(); // –ú–æ—Ç–æ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
    } else {
      Serial.println("üõë –í—ã–∫–ª—é—á–∞–µ–º –º–æ—Ç–æ—Ä");
      motor.setSpeed(0);
      motor.resume(); // –¢–µ–ø–µ—Ä—å –º–æ—Ç–æ—Ä —Å–Ω–æ–≤–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
    }
  }

  // –ï—Å–ª–∏ –º–æ—Ç–æ—Ä –≤ —Ä–µ–∂–∏–º–µ loop(), –æ–Ω –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
  // –ï—Å–ª–∏ –º–æ—Ç–æ—Ä –≤ —Ä–µ–∂–∏–º–µ resume(), –æ–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã

  delay(10); // –¥–ª—è Serial
}
